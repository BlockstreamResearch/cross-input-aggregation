#+TITLE: Cross-input-aggregation savings per tx

#+BEGIN_SRC python :session :results value :exports both
# Transaction with segwit v1 spends and outputs.
# Outputs size in bytes and weight units.
def tx_size(n_inputs, n_outputs):
    assert(n_inputs <= 252 and n_outputs <= 252)
    return list(map(lambda mult: (
        mult*(
            4     # version
            + 1   # number of inputs
            + n_inputs * (
                32 + 4 # prevout
                + 1    # script len
                + 4)   # sequence
            + 1   # number of outputs
            + n_outputs * (
                8       # amount
                + 1     # script len
                + 33)   # script
             + 4)  # locktime
         + n_inputs * (
             1       # witness stack items
             + 1     # witness item len
             + 64)), # BIP-340 sig
      [1, 4]))


# Average according to https://transactionfee.info/
n_inputs = 2.73
n_outputs = 2.8

size = tx_size(n_inputs, n_outputs)
half_agged = map(lambda s: s - n_inputs*32, size)
full_agged = map(lambda s: s - (n_inputs-1)*64, size)
both_agged = map(lambda s: s - (n_inputs-1)*64 - 32, size)
max_agged = map(lambda s: s - n_inputs*64, size)

def savings(name, agged_sizes):
    return [name] + ["%.1f%%" % ((1 - a/b)*100) for (a,b) in zip(agged_sizes, size)]

[
    [ "", "bytes", "weight units" ],
    None,
    savings("half aggregation", half_agged),
    savings("full aggregation", full_agged),
    savings("both", both_agged),
    savings("max (like infinite large full agged coinjoin)", max_agged)
]
#+end_src

#+RESULTS:
|                                               | bytes | weight units |
|-----------------------------------------------+-------+--------------|
| half aggregation                              | 20.8% |         7.7% |
| full aggregation                              | 26.4% |         9.7% |
| both                                          | 34.0% |        12.5% |
| max (like infinite large full agged coinjoin) | 41.6% |        15.3% |


